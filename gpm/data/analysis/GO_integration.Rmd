---
title: "Integration of Gene Ontology Analyses"
author:
  - "Gan Lin, Genomics Facility, lgan@ukaachen.de"
  - "Dr. Chao-Chung Kuo, Genomics Facility, ckuo@ukaachen.de"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float:
      toc_collapsed: true
    toc_depth: 3
    number_sections: false
    theme: lumen
bibliography: references.bib
---

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
Tag_this_analysis <- "GO_Integration"
pvalueCutoff <- 0.05

load("data.RData")

library(data.table)
library(pheatmap)
library(openxlsx)
library(DT)
```

### [Back to front page](Analysis_Report_RNAseq.html)

# Integrated analysis

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE}
load_table <- function(fname, merging=FALSE) {
  # label <- "LPS_vs_DNP_in_WT"
#   res <- fread(paste0("GO_", label, "_res.csv"))
  res <- fread(fname)
  res <- res[,c("query","p_value","term_id","term_name")]
  res <- reshape(res, idvar = c("term_id", "term_name"), timevar = "query", direction = "wide")
  colnames(res) <- c("term_id", "term_name",
                     paste0(label,".Down"),paste0(label,".Up"))
  if (merging!=FALSE) {
    res <- merge(merging, res, by=c("term_id", "term_name"), all = T)
  }
  return(res)
}

fnames <- list.files(pattern = "GO_*_res.csv$")
for (i in 1:length(fnames)) {
    if (i==1) {
        res <- load_table(fnames[i])
        } else {
        res <- load_table(fnames[i], , merging=res)
    }
}
 
# gofilter <- unlist(read.csv("possible_GO_keywords.txt", header = F))
# res <- res[grep(paste(gofilter,collapse="|"), res$term_name),]
write.xlsx(res, file = paset0(Tag_this_analysis, "_table.xlsx"), colNames = TRUE, rowNames=FALSE)
```

```{r, echo=FALSE, results="hide", warning=FALSE, message=FALSE, fig.width=15, fig.height=20, dpi=600}
hp <- -log10(res[,c(-1,-2)])
sel_sig <- apply(hp, 1, function(x) any(x> 50, na.rm = T))
hp <- hp[sel_sig,]
hp[is.na(hp)] <- 0
# rownames(hp) <- res$term_id

save_pheatmap_pdf <- function(x, filename, width=20, height=20) {
    stopifnot(!missing(x))
    stopifnot(!missing(filename))
    pdf(filename, width=width, height=height)
    grid::grid.newpage()
    grid::grid.draw(x$gtable)
    dev.off()
}

hpobj <- pheatmap(hp,main = "GO analysis on the selected terms (-log10)",cluster_cols=F,
                  na_col = "grey", show_rownames = T, labels_row = res$term_name[sel_sig])
# hpobj
save_pheatmap_pdf(hpobj, "GO_analysis_integration_heatmap.pdf")
```


[Download the heatmap as PDF](GO_analysis_integration_heatmap.pdf)


# References

<div id="refs"></div>


# R session information

```{r, echo=FALSE, results='markup', warning=FALSE, message=TRUE}
sessionInfo()
```